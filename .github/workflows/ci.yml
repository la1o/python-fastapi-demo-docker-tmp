name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: "3.14.3"
  IMAGE_NAME: bookshelf-api

jobs:
  validate-branch:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Validate branch naming
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "Branch: $BRANCH"
          if [[ ! "$BRANCH" =~ ^feature\/.+ ]]; then
            echo "Branch name must start with feature/"
            exit 1
          fi

  test-and-build:
    runs-on: ubuntu-latest
    needs: [validate-branch]
    if: always() && (github.event_name == 'push' || needs.validate-branch.result == 'success')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r server/requirements.txt
          pip install pytest flake8 httpx

      - name: Lint
        run: flake8 server --max-line-length=100

      - name: Run tests
        run: |
          export DOCKER_DATABASE_URL=sqlite:///:memory:
          export PYTHONPATH=.
          pytest -v --disable-warnings

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:${{ github.sha }} .

  publish:
    if: github.ref == 'refs/heads/main'
    needs: test-and-build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build image
        run: |
          docker build -t $IMAGE_NAME:${{ github.sha }} .

      - name: Tag as latest
        run: |
          docker tag $IMAGE_NAME:${{ github.sha }} $IMAGE_NAME:latest
